import { readdir, readFile, writeFile } from 'fs/promises';
import { join, parse } from 'path';
import matter from 'gray-matter';

const BLOG_DIR = 'src/blog';
const OUTPUT_FILE = 'src/blog/loader.ts';

async function generateBlogLoader() {
  try {
    const files = await readdir(BLOG_DIR);
    const mdxFiles = files.filter(file => file.endsWith('.mdx'));
    
    if (mdxFiles.length === 0) {
      console.log('No MDX files found in blog directory');
      return;
    }

    const posts = await Promise.all(mdxFiles.map(parsePost));
    const validPosts = posts.filter(Boolean);
    
    if (validPosts.length === 0) {
      console.error('No valid posts found');
      process.exit(1);
    }

    const loaderContent = buildLoaderFile(validPosts);
    await writeFile(OUTPUT_FILE, loaderContent, 'utf-8');
    console.log(`âœ“ Generated blog loader with ${validPosts.length} post(s)`);
  } catch (error) {
    console.error('Error generating blog loader:', error);
    process.exit(1);
  }
}

function calculateReadingTime(text) {
  const wordsPerMinute = 225;
  const wordCount = text.trim().split(/\s+/).length;
  const readingTime = Math.ceil(wordCount / wordsPerMinute);
  return Math.max(1, readingTime);
}

async function parsePost(filename) {
  const slug = parse(filename).name;
  const filePath = join(BLOG_DIR, filename);
  
  try {
    const content = await readFile(filePath, 'utf-8');
    const { data, content: markdown } = matter(content);
    const readingTime = calculateReadingTime(markdown);
    
    return {
      slug,
      varName: createValidIdentifier(slug),
      frontmatter: { ...data, readingTime },
      content: markdown
    };
  } catch (error) {
    console.error(`Error parsing ${filename}:`, error.message);
    return null;
  }
}

function createValidIdentifier(slug) {
  let identifier = slug
    .split('')
    .map(char => /[a-zA-Z0-9]/.test(char) ? char : '_')
    .join('');
  
  if (/^[0-9]/.test(identifier)) {
    identifier = '_' + identifier;
  }
  
  return identifier;
}

function buildLoaderFile(posts) {
  const imports = posts.flatMap(post => [
    `const ${post.varName}_content = ${JSON.stringify(post.content)};`,
    `const ${post.varName}_data = ${JSON.stringify(post.frontmatter)};`
  ]);
  
  const addPostCalls = posts.map(post => 
    `addPost(${JSON.stringify(post.slug)}, ${post.varName}_data, ${post.varName}_content);`
  );
  
  return `import { addPost } from "../api";

// Auto-generated blog post loader
// This file is automatically generated by scripts/generate-blog-loader.mjs
// Do not edit manually - your changes will be overwritten

${imports.join('\n')}

${addPostCalls.join('\n')}
`;
}

generateBlogLoader();